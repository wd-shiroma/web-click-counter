var ws,res={},context=new AudioContext,share_url={toot:"https://mastportal.info/intent?text=",tweet:"https://twitter.com/intent/tweet?text="},user_counts={};effects.forEach(function(t){Array.isArray(res[t.button])||(res[t.button]=[]);var e=new XMLHttpRequest,n="/sounds/"+t.file;e.responseType="arraybuffer",e.onreadystatechange=function(){4!==e.readyState||0!==e.status&&200!==e.status||(e.response?context.decodeAudioData(e.response,function(e){res[t.button].push(Object.assign(t,{source:n,buffer:e}))}):(console.log("failed to get resource: "+n),resource.buffer=void 0))},e.open("GET",n,!0),e.send("")});var share=function(){var t=$(this).parents(".btn_form").data("type"),e=$(this).prop("class"),n=$(this).parent().prop("class"),r=$(this).parent().prevAll(".counter"),o=$("#"+n+"_text").text(),s=$("#page_title").text(),a=location.href,u=$(this).parent().prevAll(".btn").text(),c="share_button"===n?r.text():0,i=Array.from($(".counter")).reduce((t,e)=>("number"==typeof t?t:parseInt($(t).text()))+parseInt($(e).text()))||0,l=user_counts[t]||0,f=Object.keys(user_counts)||[];console.log(f,user_counts);var p=f.length>1?f.reduce((t,e)=>parseInt(("number"==typeof t?t:user_counts[t])+user_counts[e])):f.length>0?user_counts[f[0]]:0,g=encodeURIComponent(o.replace(/{title}/g,s).replace(/{url}/g,a).replace(/{button_title}/g,u).replace(/{button_count}/g,c).replace(/{all_count}/g,i).replace(/{user_button_count}/g,l).replace(/{user_all_count}/g,p));console.log(share_url[e]+g),window.open(share_url[e]+g,"_blank")},countup=function(t){var e=$(t.target).parent(),n=e.find(".counter"),r={button:e.data("type")};user_counts[r.button]||(user_counts[r.button]=0),res[r.button]&&play_effect(res[r.button]),n.text(parseInt(n.text())+1),ws.send(JSON.stringify(r)),user_counts[r.button]++},play_effect=function(t=[]){if(!t.length)return!1;var e,n=t.reduce((t,e)=>(t.weight?t.weight:t)+e.weight),o=Math.floor(Math.random()*(n+1));for(r in t)if(e=t[r],(o-=t[r].weight)<0)break;if(!e)return!1;var s=context.createBufferSource();s.buffer=e.buffer,s.connect(context.destination),s.start(0)},closed_streaming=function(){console.log("closed"),$(".streaming_error").show("first")},start_streaming=function(){console.log("start"),ws=null,(ws=new WebSocket("wss://"+domain+"/streaming")).onmessage=receive_message,ws.onclose=closed_streaming,$(".streaming_error").hide("first")},receive_message=function(t){var e=JSON.parse(t.data);if(e.polling)return!0;$(".counter").each(function(){$(this).parent().data("type")===e.button&&parseInt($(this).text())<e.counter&&$(this).text(e.counter)})};$(function(){start_streaming(),$(".btn").on("click",countup),$(".streaming_connect").on("click",start_streaming),$("[name=btn_share]").on("click",share)});